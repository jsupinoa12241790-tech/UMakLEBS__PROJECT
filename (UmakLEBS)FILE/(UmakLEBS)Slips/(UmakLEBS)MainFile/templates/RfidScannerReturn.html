<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UMAK-LEBS - RFID Scanner</title>

    <!-- font link -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;700&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="{{ url_for('static', filename='ScannerStyle.css') }}">
</head>
<body>
    <!-- Topbar -->
    <header class="topbar">
        <img src="{{ url_for('static', filename='Icons/Umak.png') }}" alt="UMak Logo">
        <h1>University of Makati - LEBS</h1>
    </header>

    <!-- Sidebar -->
    <aside class="sidebar">
    <div class="profMenu" onclick="showProfile()"> <!-- Profile -->
        <div class="profIcon">
            <img src="{{ url_for('static', filename='Icons/Profile.png') }}" alt="Umak Logo">
            </div>
                <div id="logoutDropdown" class="logout-dropdown">
                <a href="{{ url_for('logout') }}" class="logout-btn">
                    <img src="{{ url_for('static', filename='Icons/LogOut Icon.png') }}" alt="Logout Icon">
                    Log Out
                </a>
            </div>
        </div>
        <a href="{{ url_for('dashboard') }}" class="nav-item">
        <div class="nav-icon"><img src="{{ url_for('static', filename='Icons/Dashboard.png') }}" alt="Dashboard Icon" /></div>
        <span>Dashboard</span>
        </a>

        <a href="{{ url_for('borrow_page') }}" class="nav-item">
        <div class="nav-icon">
            <img src="{{ url_for('static', filename='Icons/Borrow.png') }}" alt="Borrow Icon" />
        </div>
        <span>Borrow</span>
        </a>

        <div class="nav-item active" onclick="showSection('rfid_scanner_return')">
            <div class="nav-icon">
            <img src="{{ url_for('static', filename='Icons/Return.png') }}" alt="Return Icon" />
            </div>
            <span>Return</span>
        </div>

        <a href="{{ url_for('inventory_page') }}" class="nav-item">
        <div class="nav-icon"><img src="{{ url_for('static', filename='Icons/Inventory.png') }}" alt="Inventory Icon" /></div>
        <span>Inventory</span>
        </a>
        <a href="{{ url_for('users_page') }}" class="nav-item">
        <div class="nav-icon"><img src="{{ url_for('static', filename='Icons/Users.png') }}" alt="Users Icon" /></div>
        <span>Users</span>
        </a>
        <a href="{{ url_for('history_page') }}" class="nav-item">
        <div class="nav-icon">
            <img src="{{ url_for('static', filename='Icons/History.png') }}" alt="History Icon" />
        </div>
        <span>History</span>
        </a>

        <a href="{{ url_for('report_page') }}" class="nav-item">
        <div class="nav-icon">
            <img src="{{ url_for('static', filename='Icons/Report.png') }}" alt="Report Icon" />
        </div>
        <span>Reports</span>
        </a>

        <a href="{{ url_for('kiosk_page') }}" target="_blank" class="nav-item" title="Open Kiosk in New Tab">
        <div class="nav-icon">
            <img src="{{ url_for('static', filename='Icons/Kiosk Icon.png') }}" alt="Kiosk Icon" />
        </div>
        <span> Kiosk</span>
        </a>
    </aside>

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        <div class="flash-container">
        {% for category, message in messages %}
            <div class="flash-message {{ category }}">{{ message }}</div>
        {% endfor %}
        </div>
    {% endif %}
    {% endwith %}
    <!-- Main Section -->
    <div class="main-content">
        <div class="login-container">
            <h1 class="system-title">UMak LEBS</h1>
            <p class="system-subtitle">Laboratory Equipment Borrowing System</p>
            
            <!-- RFID Prompt -->
            <div class="rfid-prompt">
                <p class="prompt-text">Please tap your ID card</p>
                <p class="status-text" id="statusText">Waiting for RFID scan...</p>
            </div>
        </div>
    </div>

    <!-- Hidden Form to Send RFID -->
    <form id="rfidForm" action="{{ url_for('return_confirm') }}" method="POST">
        <input type="hidden" id="rfidInput" name="rfid">
    </form>

    <!-- Invisible input to capture scanner input -->
    <input type="text" id="scannerCatch" style="position:absolute; left:-9999px;" autofocus>

    <script>
        setTimeout(() => {
            const flash = document.querySelector('.flash-container');
            if (flash) flash.style.display = 'none';
        }, 3000);

        const rfidInput = document.getElementById("rfidInput");
        const scannerCatch = document.getElementById("scannerCatch");
        const rfidForm = document.getElementById("rfidForm");
        const statusText = document.getElementById("statusText");
        let buffer = "";

        // Listen for RFID input
        scannerCatch.addEventListener("keypress", function(e) {
            if (e.key === "Enter") {
                e.preventDefault();
                const scannedRFID = buffer.trim();
                if (scannedRFID.length > 0) {
                    rfidInput.value = scannedRFID;
                    statusText.innerText = "RFID detected! Submitting...";
                    setTimeout(() => rfidForm.submit(), 200);
                }
                buffer = "";
            } else {
                buffer += e.key;
            }
        });

        // Fallback for scanners that dump input fast
        scannerCatch.addEventListener("input", function() {
            if (this.value.length > 8) {
                rfidInput.value = this.value.trim();
                statusText.innerText = "RFID detected! Submitting...";
                setTimeout(() => rfidForm.submit(), 200);
            }
        });

        // Always refocus hidden input
        window.onload = () => scannerCatch.focus();
        document.addEventListener("click", () => scannerCatch.focus());
        // Log Out Script
        function showProfile() {
            const dropdown = document.getElementById("logoutDropdown");
            // Toggle dropdown visibility
            dropdown.style.display = dropdown.style.display === "block" ? "none" : "block";
        }

        // Hide dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById("logoutDropdown");
            const profile = document.querySelector('.profMenu');
            if (!dropdown.contains(event.target) && !profile.contains(event.target)) {
            dropdown.style.display = "none";
            }
        });

        // Prevent going back after logout
        if (window.history && window.history.pushState) {
            window.history.pushState(null, null, window.location.href);
            window.onpopstate = function() {
            window.history.pushState(null, null, window.location.href);
            };
        }
        setInterval(() => scannerCatch.focus(), 1000);
    </script>
</body>
</html>