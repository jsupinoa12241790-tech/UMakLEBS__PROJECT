<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UMAK-LEBS - RFID Scanner</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='ScannerStyle.css') }}">
</head>
<body>
    <!-- Topbar -->
    <header class="kiosk-topbar">
        <btn type="button" class="BtnKioskBack" onclick="goBackToSelection()">< Back</btn>
        <img src="{{ url_for('static', filename='Icons/Umak.png') }}">
        <h1>University of Makati - LEBS</h1>
    </header>

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        <div class="flash-container">
        {% for category, message in messages %}
            <div class="flash-message {{ category }}">{{ message }}</div>
        {% endfor %}
        </div>
    {% endif %}
    {% endwith %}
    <!-- Main Section -->
    <div class="main-content">
        <div class="login-container">
            <h1 class="system-title">UMak LEBS</h1>
            <p class="system-subtitle">Laboratory Equipment Borrowing System</p>
            
            <!-- RFID Prompt -->
            <div class="rfid-prompt">
                <p class="prompt-text">Please tap your ID card</p>
                <p class="status-text" id="statusText">Waiting for RFID scan...</p>
            </div>
        </div>
    </div>

    <!-- Hidden Form to Send RFID -->
    <form id="rfidForm" action="{{ url_for('kiosk_return_scanner') }}" method="POST" onsubmit="isSubmitting = true;">
        <input type="hidden" id="rfidInput" name="rfid">
    </form>

    <!-- Invisible input to capture scanner input -->
    <input type="text" id="scannerCatch" style="position:absolute; left:-9999px;" autofocus>

    <script>
        let isSubmitting = false;

        setTimeout(() => {
            const flash = document.querySelector('.flash-container');
            if (flash) flash.style.display = 'none';
        }, 3000);

        const rfidInput = document.getElementById("rfidInput");
        const scannerCatch = document.getElementById("scannerCatch");
        const rfidForm = document.getElementById("rfidForm");
        const statusText = document.getElementById("statusText");
        let buffer = "";

        // Listen for RFID input via keypress
        scannerCatch.addEventListener("keypress", function(e) {
            if (e.key === "Enter") {
                e.preventDefault();
                const scannedRFID = buffer.trim();
                if (scannedRFID.length > 0 && !isSubmitting) {
                    isSubmitting = true;
                    rfidInput.value = scannedRFID;
                    statusText.innerText = "RFID detected! Submitting...";
                    setTimeout(() => rfidForm.submit(), 200);
                }
                buffer = "";
            } else {
                buffer += e.key;
            }
        });

        // Fallback for scanners that dump input fast
        scannerCatch.addEventListener("input", function() {
            if (this.value.length >= 10 && !isSubmitting) {
                isSubmitting = true;
                rfidInput.value = this.value.trim();
                statusText.innerText = "RFID detected! Submitting...";
                setTimeout(() => rfidForm.submit(), 200);
            }
        });

        // Always refocus hidden input
        window.onload = () => scannerCatch.focus();
        document.addEventListener("click", () => scannerCatch.focus());
        // Log Out Script
        function showProfile() {
            const dropdown = document.getElementById("logoutDropdown");
            // Toggle dropdown visibility
            dropdown.style.display = dropdown.style.display === "block" ? "none" : "block";
        }

        // Hide dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById("logoutDropdown");
            const profile = document.querySelector('.profMenu');
            if (!dropdown.contains(event.target) && !profile.contains(event.target)) {
            dropdown.style.display = "none";
            }
        });

        // Prevent going back after logout
        if (window.history && window.history.pushState) {
            window.history.pushState(null, null, window.location.href);
            window.onpopstate = function() {
                window.history.pushState(null, null, window.location.href);
            };
        }

        setInterval(() => scannerCatch.focus(), 1000);

        // âœ… Go back to kiosk main page
        function goBackToSelection() {
            window.location.href = "{{ url_for('kiosk_page') }}";
        }
    </script>
</body>
</html>